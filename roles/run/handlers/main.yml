# Handlers: Tasks that are triggered and run only when notified.

---

- name: "Handlers | postfix.service restart"
  ansible.builtin.systemd_service:
    name: "{{ __run_postfix_servicename }}"
    state: "restarted"
  listen: "run_postfix: restart postfix.service"
  when:
    - run_postfix_service_state != 'unmanaged'


- name: "Handlers | postfix.service reload"
  ansible.builtin.systemd_service:
    name: "{{ __run_postfix_servicename }}"
    state: "reloaded"
  listen: "run_postfix: reload postfix.service"
  when:
    - run_postfix_service_state != 'unmanaged'


- name: "Handlers | Update Postfix databases / lookup tables: (hash|btree|dbm) ... "
  ansible.builtin.command:
    cmd: "{{ __run_postmap_executable }} {{ item['value'] | regex_replace('^[^:]+:(.*)$', '\\1') }}"
  loop: "{{ __run_postfix_merged_maincf_settings | dict2items }}"
  when:
    - __run_postfix_merged_maincf_settings is defined
      # item['key'] != 'alias_maps' [...]: exclude files where "newaliases" or "postalias" has to be used
    - ((item['key'] == 'relay_domains') or
        (item['key'] | regex_search('_map$')) or
        (item['value'] | regex_search('^(hash|btree|dbm):/.+'))) and
      (item['key'] != 'alias_maps') and
      (item['key'] != 'alias_database')
  changed_when:
    # The command does not output anything useful to detect changes and rewrites
    # the .db file in any successful case, even if the input data was not
    # changed, so there is a change in any case. This is no idempotence problem
    # as this handler should only get triggered when Postfix configuration has
    # actually changed.
    - __run_postfix_postmap_result['rc'] == 0
  register: __run_postfix_postmap_result
  listen: "run_postfix: update lookup tables"


- name: "Handlers | Update aliases for smtpd"
  ansible.builtin.command:
    cmd: "{{ __run_newaliases_executable }}"
  changed_when:
    # The command does not output anything useful to detect changes and rewrites
    # the .db file in any successful case, even if the input data was not
    # changed, so there is a change in any case. This is no idempotence problem
    # as this handler should only get triggered when Postfix configuration has
    # actually changed.
    - __run_postfix_newaliases_result['rc'] == 0
  register: __run_postfix_newaliases_result
  listen: "run_postfix: update aliases"
